# Implementation Plan: Investment Agent (Phase 2)

**Branch**: `001-risk-quiz-strategies` | **Date**: 2026-02-28 | **Spec**: `specs/001-risk-quiz-strategies/spec.md`
**Input**: Agent extension — Claude Agent SDK + Openfort MCP + Aave MCP

## Summary

Build an autonomous investment agent (`apps/agent`) that uses Claude's
Agent SDK with MCP tools to execute investment decisions. When a user
selects a strategy, the agent reads the strategy parameters (pool
allocations, allowed chains, rebalance threshold), fetches live Aave
pool rates via MCP, evaluates gas costs, and executes optimal supply
operations through Openfort's policy-enforced backend wallet. The agent
reasons about the best allocation considering the user's amount and
network fees to maximize return on investment.

## Technical Context

**Language/Version**: TypeScript 5.x (Node.js 20+)
**Primary Dependencies**: `@anthropic-ai/claude-agent-sdk`, `@openfort/openfort-node`, Tairon-ai/aave-mcp, Zod
**Storage**: PostgreSQL (existing, via NestJS API) — agent reads strategy data from API
**Testing**: Jest — domain unit tests for allocation logic
**Target Platform**: Node.js server (runs alongside API)
**Project Type**: Agent service (standalone app in monorepo)
**Performance Goals**: Agent decision + execution within 30 seconds
**Constraints**: Base Sepolia testnet only, USDC only, Openfort policy-enforced transactions
**Scale/Scope**: Single-user demo, single-chain, 3 strategies

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Security-First | PASS | Transactions via Openfort policy-enforced wallet. Agent cannot send to arbitrary addresses. Full audit trail logged. |
| II. Zero-Friction UX | PASS | Agent runs server-side, user only sees dashboard results. No gas prompts or chain selection. |
| III. Guardrailed Autonomy | PASS | Agent executes only through Openfort policies. Cost-benefit check before rebalance. Respects strategy constraints (allowed pools, chains, allocation %). |
| IV. Transparency & Trust | PASS | Agent logs every decision with rationale. Results visible on dashboard. |
| V. Simplicity (YAGNI) | PASS | Single chain (Base), single asset (USDC), no real cross-chain ops. Uses existing MCP servers rather than building custom protocol integrations. |

## Project Structure

### Documentation (this feature)

```text
specs/001-risk-quiz-strategies/
├── plan.md              # This file (updated for Phase 2)
├── research.md          # Updated with R11-R15 (agent research)
├── data-model.md        # Updated with AgentAction entity
├── quickstart.md        # Updated with agent setup steps
├── contracts/
│   ├── api.md           # Existing API contracts
│   └── agent.md         # Agent service contracts (new)
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (repository root)

```text
apps/
├── api/                        # Existing NestJS backend
│   └── src/modules/
│       ├── quiz/               # Risk assessment (existing)
│       ├── strategy/           # Strategies (existing)
│       └── investment/         # Investments (existing)
│           └── infrastructure/
│               └── investment.controller.ts  # Add POST /investments/execute endpoint
├── web/                        # Existing Next.js frontend
│   └── src/
│       ├── app/dashboard/      # Update to show agent actions
│       └── components/dashboard/
│           └── AgentActions.tsx # New component for agent action log
└── agent/                      # NEW: Investment agent
    ├── package.json
    ├── tsconfig.json
    ├── .env.example
    └── src/
        ├── index.ts            # Entry point — runs agent via query()
        ├── agent-prompt.ts     # System prompt with investment rules
        ├── mcp/
        │   └── openfort-tools.ts  # Custom in-process MCP tools wrapping Openfort SDK
        ├── domain/
        │   └── allocation-optimizer.ts  # Pure logic: given rates + gas, compute optimal allocation
        └── test/
            └── allocation-optimizer.spec.ts  # Unit tests for optimizer
```

**Structure Decision**: Add `apps/agent` as a third workspace app.
The agent is a standalone TypeScript process that connects to MCP
servers (Aave MCP via SSE, custom Openfort tools in-process) and
calls the NestJS API for strategy data. This keeps the agent
decoupled from the API while sharing the monorepo workspace.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| 3rd workspace app (`apps/agent`) | Agent needs autonomous runtime with MCP server connections — cannot run inside NestJS request lifecycle | Embedding agent in API creates tight coupling and blocks request threads during long-running agent operations |
